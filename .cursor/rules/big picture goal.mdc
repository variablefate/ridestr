---
description: scope and big picture goalsclear of the rideshare implementation
globs: 
alwaysApply: true
---
##scope and goal of the rideshare implementation being added to Amethyst


## Core Protocol: NIP-014173

The implementation is built around **NIP-014173**, a Nostr Implementation Possibility that defines a decentralized ridesharing protocol with the following characteristics:

1. **Privacy-Focused**: Uses two-stage location sharing where only approximate locations are shared until mutual consent is established
2. **Decentralized Communication**: Leverages Nostr for peer-to-peer communication between riders and drivers
3. **Bitcoin Lightning Payments**: Integrates native Bitcoin Lightning Network for payments
4. **No Central Authority**: Eliminates reliance on centralized platforms, putting users in direct control

## Key Components Implemented

1. **Nine Custom Event Types** (using "173" base from NIP-014173 to avoid conflicts):
   - DriverAvailabilityEvent (Kind 30173): Broadcasts driver location and availability (parameterized replaceable)
   - RideOfferEvent (Kind 3173): Riders respond to available drivers with fare estimates
   - RideAcceptanceEvent (Kind 3174): Drivers accept ride offers
   - RideConfirmationEvent (Kind 3175): Riders confirm rides and share precise pickup location
   - DriverStatusEvent (Kind 20173): Drivers update status and request payment upon completion (ephemeral)
   - PinSubmissionEvent (Kind 3176): Drivers submit PIN for verification at pickup
   - PickupVerificationEvent (Kind 3177): Riders verify driver's PIN submission
   - RideshareChatEvent (Kind 3178): Private chat messages during ride
   - RideHistoryEvent (Kind 30174): Encrypted backup of ride history (parameterized replaceable)

2. **UI Implementation**:
   - Dedicated RideshareScreen with both driver and rider modes
   - Location selection and map integration
   - Ride state management through the RideStage enum
   - Driver availability listing and selection

3. **Minimized External API Usage**:
   - Custom valhalla routing engine implementation that eliminates reliance on external routing APIs
   - Simplified fare calculation based on distance and time

4. **Privacy-Preserving Design**:
   - Two-tier location sharing (approximate first, precise only after mutual agreement)
   - NIP-44 encryption for sensitive data exchange
   - Decentralized communications over Nostr relays

5. **Local Processing**:
   - Vahalla routing engine local calculations to find out the distance and time of a route, as well as estimate fares
   - No dependency on Google Maps if you want to use local region OSM data you can download

## Technical Integration

The implementation is fully integrated with Amethyst's existing architecture:
- Built on Kotlin and Jetpack Compose
- Follows MVVM architecture pattern
- Uses Kotlin Flow for state management
- Leverages Amethyst's existing Nostr communication infrastructure


The rideshare implementation represents a significant step toward truly decentralized peer-to-peer transportation services. It demonstrates how Nostr can be extended beyond social media to support direct economic activity while preserving user privacy and eliminating reliance on centralized platforms. By using local calculations and minimizing external API dependencies, the implementation aligns with Nostr's ethos of user sovereignty and resilience.
